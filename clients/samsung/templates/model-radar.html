<!-- === Model Performance Radar Chart ===
D3.js radar chart comparing AI models
Axes: Total Mentions, Positive Sentiment, Unique Concepts, Top Position Rate
3 overlapping polygons (SearchGPT, Google AI Overview, Google AI Mode)
-->

<!-- Radar Chart Section HTML -->
<div class="container">
    <div class="chart-card">
        <div class="chart-header">
            <div class="chart-title">
                AI Model Performance Comparison
                <div class="tooltip-icon">
                    <span>?</span>
                    <div class="tooltip-text">Compare Samsung's visibility performance across different AI models. Each axis represents a normalized metric (0-100).</div>
                </div>
            </div>
            <button class="download-btn" title="Download">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                    <polyline points="7 10 12 15 17 10"/>
                    <line x1="12" y1="15" x2="12" y2="3"/>
                </svg>
            </button>
        </div>
        <div class="radar-container" id="model-radar"></div>
        <div class="radar-legend" id="radar-legend"></div>
    </div>
</div>

<!-- Radar Chart CSS -->
<style>
.radar-container {
    width: 100%;
    display: flex;
    justify-content: center;
    padding: var(--spacing-lg) 0;
}

.radar-container svg {
    overflow: visible;
}

.radar-axis-line {
    stroke: var(--color-border);
    stroke-width: 1;
}

.radar-axis-circle {
    fill: none;
    stroke: var(--color-border);
    stroke-width: 1;
    stroke-dasharray: 4 4;
}

.radar-axis-label {
    font-family: var(--font-body);
    font-size: 12px;
    fill: var(--color-text-secondary);
    text-anchor: middle;
}

.radar-polygon {
    fill-opacity: 0.2;
    stroke-width: 2;
    transition: fill-opacity 0.2s, stroke-width 0.2s;
}

.radar-polygon:hover {
    fill-opacity: 0.35;
    stroke-width: 3;
}

.radar-point {
    stroke: #fff;
    stroke-width: 2;
    cursor: pointer;
    transition: r 0.2s;
}

.radar-point:hover {
    r: 6;
}

.radar-legend {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: var(--spacing-xl);
    padding: var(--spacing-md) 0;
    border-top: 1px solid var(--color-border);
    margin-top: var(--spacing-md);
}

.radar-legend-item {
    display: flex;
    align-items: center;
    gap: var(--spacing-sm);
    font-family: var(--font-body);
    font-size: 13px;
    color: var(--color-text-primary);
    cursor: pointer;
    padding: 4px 8px;
    border-radius: var(--radius-md);
    transition: background 0.2s;
}

.radar-legend-item:hover {
    background: var(--color-bg-page);
}

.radar-legend-item.dimmed {
    opacity: 0.4;
}

.radar-legend-color {
    width: 16px;
    height: 3px;
    border-radius: 2px;
}

/* Radar tooltip */
.radar-tooltip {
    position: fixed;
    background: #333;
    color: white;
    padding: 8px 12px;
    border-radius: var(--radius-md);
    font-size: 12px;
    font-family: var(--font-body);
    pointer-events: none;
    opacity: 0;
    transition: opacity 0.2s;
    z-index: 1000;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}

.radar-tooltip.visible {
    opacity: 1;
}

.radar-tooltip .tooltip-model {
    font-weight: 600;
    margin-bottom: 4px;
}

.radar-tooltip .tooltip-metric {
    color: rgba(255,255,255,0.7);
}

.radar-tooltip .tooltip-value {
    font-weight: 600;
}

.radar-value-labels {
    font-family: var(--font-body);
    font-size: 10px;
    fill: var(--color-text-secondary);
}
</style>

<!-- Radar Tooltip Element -->
<div class="radar-tooltip" id="radar-tooltip"></div>

<!-- Radar Chart JavaScript -->
<script>
(function() {
    // Configuration
    const config = {
        width: 450,
        height: 450,
        margin: 80,
        levels: 5,
        maxValue: 100,
        labelFactor: 1.2,
        opacityArea: 0.25,
        dotRadius: 4
    };

    const radius = Math.min(config.width, config.height) / 2 - config.margin;

    // Metrics (axes)
    const metrics = [
        { key: 'mentions', label: 'Total Mentions' },
        { key: 'sentiment', label: 'Positive Sentiment' },
        { key: 'concepts', label: 'Unique Concepts' },
        { key: 'topPosition', label: 'Top Position Rate' }
    ];

    const angleSlice = (Math.PI * 2) / metrics.length;

    // Model colors
    const modelColors = {
        'search-gpt': '#01c3b0',
        'google-ai-overview': '#0277c6',
        'google-ai-mode': '#feb447'
    };

    const modelLabels = {
        'search-gpt': 'ChatGPT',
        'google-ai-overview': 'Google AI Overview',
        'google-ai-mode': 'Google AI Mode'
    };

    // Sample data
    const sampleData = [
        {
            model: 'search-gpt',
            label: 'ChatGPT',
            color: '#01c3b0',
            values: [85, 72, 78, 65]
        },
        {
            model: 'google-ai-overview',
            label: 'Google AI Overview',
            color: '#0277c6',
            values: [78, 68, 82, 71]
        },
        {
            model: 'google-ai-mode',
            label: 'Google AI Mode',
            color: '#feb447',
            values: [65, 75, 70, 80]
        }
    ];

    const tooltip = d3.select('#radar-tooltip');
    let activeModels = new Set(sampleData.map(d => d.model));

    function renderRadar(data) {
        const container = d3.select('#model-radar');
        container.selectAll('*').remove();

        const svg = container.append('svg')
            .attr('width', config.width)
            .attr('height', config.height);

        const g = svg.append('g')
            .attr('transform', `translate(${config.width / 2}, ${config.height / 2})`);

        // Draw circular grid
        const rScale = d3.scaleLinear()
            .domain([0, config.maxValue])
            .range([0, radius]);

        // Circular grid lines
        for (let level = 1; level <= config.levels; level++) {
            const levelRadius = radius * (level / config.levels);

            g.append('circle')
                .attr('class', 'radar-axis-circle')
                .attr('r', levelRadius);

            // Level labels
            g.append('text')
                .attr('class', 'radar-value-labels')
                .attr('x', 4)
                .attr('y', -levelRadius)
                .attr('dy', '0.35em')
                .text((config.maxValue * level / config.levels).toFixed(0));
        }

        // Draw axis lines and labels
        metrics.forEach((metric, i) => {
            const angle = angleSlice * i - Math.PI / 2;

            // Axis line
            g.append('line')
                .attr('class', 'radar-axis-line')
                .attr('x1', 0)
                .attr('y1', 0)
                .attr('x2', radius * Math.cos(angle))
                .attr('y2', radius * Math.sin(angle));

            // Axis label
            const labelRadius = radius * config.labelFactor;
            g.append('text')
                .attr('class', 'radar-axis-label')
                .attr('x', labelRadius * Math.cos(angle))
                .attr('y', labelRadius * Math.sin(angle))
                .attr('dy', '0.35em')
                .text(metric.label);
        });

        // Radial line generator
        const radarLine = d3.lineRadial()
            .radius(d => rScale(d))
            .angle((d, i) => i * angleSlice)
            .curve(d3.curveLinearClosed);

        // Draw polygons for each model
        data.forEach(modelData => {
            if (!activeModels.has(modelData.model)) return;

            const polygonGroup = g.append('g')
                .attr('class', `radar-model-${modelData.model}`);

            // Polygon area
            polygonGroup.append('path')
                .attr('class', 'radar-polygon')
                .attr('d', radarLine(modelData.values))
                .attr('fill', modelData.color)
                .attr('stroke', modelData.color)
                .on('mouseenter', function() {
                    d3.selectAll('.radar-polygon').style('fill-opacity', 0.1);
                    d3.select(this).style('fill-opacity', 0.4);
                })
                .on('mouseleave', function() {
                    d3.selectAll('.radar-polygon').style('fill-opacity', config.opacityArea);
                });

            // Data points
            modelData.values.forEach((value, i) => {
                const angle = angleSlice * i - Math.PI / 2;
                const x = rScale(value) * Math.cos(angle);
                const y = rScale(value) * Math.sin(angle);

                polygonGroup.append('circle')
                    .attr('class', 'radar-point')
                    .attr('cx', x)
                    .attr('cy', y)
                    .attr('r', config.dotRadius)
                    .attr('fill', modelData.color)
                    .on('mouseenter', function(event) {
                        tooltip
                            .html(`
                                <div class="tooltip-model" style="color: ${modelData.color}">${modelData.label}</div>
                                <div>
                                    <span class="tooltip-metric">${metrics[i].label}:</span>
                                    <span class="tooltip-value">${value.toFixed(0)}</span>
                                </div>
                            `)
                            .classed('visible', true)
                            .style('left', (event.pageX + 10) + 'px')
                            .style('top', (event.pageY - 10) + 'px');
                    })
                    .on('mousemove', function(event) {
                        tooltip
                            .style('left', (event.pageX + 10) + 'px')
                            .style('top', (event.pageY - 10) + 'px');
                    })
                    .on('mouseleave', function() {
                        tooltip.classed('visible', false);
                    });
            });
        });

        // Render legend
        renderLegend(data);
    }

    function renderLegend(data) {
        const legend = d3.select('#radar-legend');
        legend.selectAll('*').remove();

        data.forEach(modelData => {
            const item = legend.append('div')
                .attr('class', `radar-legend-item ${activeModels.has(modelData.model) ? '' : 'dimmed'}`)
                .on('click', function() {
                    if (activeModels.has(modelData.model)) {
                        if (activeModels.size > 1) {
                            activeModels.delete(modelData.model);
                        }
                    } else {
                        activeModels.add(modelData.model);
                    }
                    renderRadar(data);
                });

            item.append('div')
                .attr('class', 'radar-legend-color')
                .style('background', modelData.color);

            item.append('span')
                .text(modelData.label);
        });
    }

    // Load data from Supabase
    async function loadRadarData() {
        try {
            if (typeof SupabaseData === 'undefined') {
                console.warn('SupabaseData not available, using sample data');
                renderRadar(sampleData);
                return;
            }

            const mentionsData = await SupabaseData.fetchDailyMentions(null, 'all');

            if (mentionsData.length > 0) {
                const radarData = SupabaseData.transform.radar(mentionsData);

                // Transform to expected format
                const formattedData = radarData.data.map(d => ({
                    model: d.model,
                    label: d.label,
                    color: d.color,
                    values: d.values
                }));

                if (formattedData.length > 0) {
                    activeModels = new Set(formattedData.map(d => d.model));
                    renderRadar(formattedData);
                } else {
                    renderRadar(sampleData);
                }
            } else {
                renderRadar(sampleData);
            }
        } catch (error) {
            console.error('Error loading radar data:', error);
            renderRadar(sampleData);
        }
    }

    // Listen for filter changes
    document.addEventListener('filtersChanged', loadRadarData);

    // Initial render
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', loadRadarData);
    } else {
        loadRadarData();
    }
})();
</script>

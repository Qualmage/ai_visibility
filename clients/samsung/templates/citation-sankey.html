<!-- === Citation Flow Sankey Diagram ===
D3.js Sankey showing: Topics → Prompts → URLs
Flow width = volume/citations
Highlight Samsung-owned vs competitor paths
-->

<!-- Sankey Section HTML -->
<div class="container">
    <div class="chart-card full-width">
        <div class="chart-header">
            <div class="chart-title">
                Citation Flow Analysis
                <div class="tooltip-icon">
                    <span>?</span>
                    <div class="tooltip-text">Visualizes the flow from topics to prompts to cited URLs. Width indicates volume. Samsung-owned sources are highlighted in blue.</div>
                </div>
            </div>
            <button class="download-btn" title="Download">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                    <polyline points="7 10 12 15 17 10"/>
                    <line x1="12" y1="15" x2="12" y2="3"/>
                </svg>
            </button>
        </div>
        <div class="sankey-container" id="citation-sankey"></div>
        <div class="sankey-legend">
            <div class="sankey-legend-item">
                <span class="legend-line samsung"></span>
                <span>Samsung-owned sources</span>
            </div>
            <div class="sankey-legend-item">
                <span class="legend-line earned"></span>
                <span>Earned media sources</span>
            </div>
            <div class="sankey-legend-item">
                <span class="legend-line other"></span>
                <span>Other sources</span>
            </div>
        </div>
    </div>
</div>

<!-- Sankey CSS -->
<style>
.sankey-container {
    width: 100%;
    min-height: 500px;
    padding: var(--spacing-lg) 0;
    overflow-x: auto;
}

.sankey-container svg {
    display: block;
    margin: 0 auto;
}

.sankey-node rect {
    stroke: #fff;
    stroke-width: 1px;
    cursor: pointer;
    transition: opacity 0.2s;
}

.sankey-node text {
    font-family: var(--font-body);
    font-size: 11px;
    fill: var(--color-text-primary);
    pointer-events: none;
}

.sankey-link {
    fill: none;
    stroke-opacity: 0.4;
    transition: stroke-opacity 0.2s;
}

.sankey-link:hover {
    stroke-opacity: 0.7;
}

.sankey-link.samsung {
    stroke: var(--color-brand-samsung);
}

.sankey-link.earned {
    stroke: #10a37f;
}

.sankey-link.other {
    stroke: var(--color-neutral);
}

.sankey-legend {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: var(--spacing-xl);
    padding: var(--spacing-md) 0;
    border-top: 1px solid var(--color-border);
    margin-top: var(--spacing-md);
}

.sankey-legend-item {
    display: flex;
    align-items: center;
    gap: var(--spacing-sm);
    font-family: var(--font-body);
    font-size: 12px;
    color: var(--color-text-secondary);
}

.sankey-legend-item .legend-line {
    width: 24px;
    height: 4px;
    border-radius: 2px;
}

.sankey-legend-item .legend-line.samsung {
    background: var(--color-brand-samsung);
}

.sankey-legend-item .legend-line.earned {
    background: #10a37f;
}

.sankey-legend-item .legend-line.other {
    background: var(--color-neutral);
}

/* Sankey tooltip */
.sankey-tooltip {
    position: fixed;
    background: #333;
    color: white;
    padding: 10px 14px;
    border-radius: var(--radius-md);
    font-size: 12px;
    font-family: var(--font-body);
    pointer-events: none;
    opacity: 0;
    transition: opacity 0.2s;
    z-index: 1000;
    max-width: 300px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}

.sankey-tooltip.visible {
    opacity: 1;
}

.sankey-tooltip .tooltip-title {
    font-weight: 600;
    font-size: 13px;
    margin-bottom: 4px;
    word-break: break-word;
}

.sankey-tooltip .tooltip-type {
    color: rgba(255,255,255,0.7);
    font-size: 10px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin-bottom: 4px;
}

.sankey-tooltip .tooltip-value {
    font-weight: 600;
    font-size: 14px;
}

.sankey-tooltip .tooltip-flow {
    margin-top: 6px;
    padding-top: 6px;
    border-top: 1px solid rgba(255,255,255,0.2);
    font-size: 11px;
}

/* Node type colors */
.sankey-node.topic rect { fill: var(--color-accent-purple); }
.sankey-node.prompt rect { fill: var(--color-accent-blue); }
.sankey-node.url rect { fill: var(--color-neutral); }
.sankey-node.url.samsung rect { fill: var(--color-brand-samsung); }
.sankey-node.url.earned rect { fill: #10a37f; }
</style>

<!-- Sankey Tooltip Element -->
<div class="sankey-tooltip" id="sankey-tooltip"></div>

<!-- Sankey JavaScript -->
<script src="https://unpkg.com/d3-sankey@0.12.3/dist/d3-sankey.min.js"></script>
<script>
(function() {
    // Configuration
    const config = {
        width: 1000,
        height: 500,
        margin: { top: 20, right: 150, bottom: 20, left: 20 },
        nodeWidth: 20,
        nodePadding: 12
    };

    const tooltip = d3.select('#sankey-tooltip');

    // Sample data structure
    const sampleData = {
        nodes: [
            // Topics (left column)
            { name: 'TV Reviews', type: 'topic' },
            { name: 'TV Features', type: 'topic' },
            { name: 'Gaming TVs', type: 'topic' },
            { name: 'OLED Comparison', type: 'topic' },
            { name: 'Best TVs 2026', type: 'topic' },
            // Prompts (middle column)
            { name: 'best oled tv for movies', type: 'prompt' },
            { name: 'samsung vs lg qled', type: 'prompt' },
            { name: 'best gaming tv 2026', type: 'prompt' },
            { name: 'which tv has best picture', type: 'prompt' },
            { name: 'mini led vs oled brightness', type: 'prompt' },
            { name: 'top rated 75 inch tvs', type: 'prompt' },
            { name: 'best tv for ps5 gaming', type: 'prompt' },
            // URLs (right column)
            { name: 'samsung.com/tv/qled', type: 'url', isSamsung: true },
            { name: 'samsung.com/tv/neo-qled', type: 'url', isSamsung: true },
            { name: 'rtings.com/tv/reviews', type: 'url', isSamsung: false },
            { name: 'cnet.com/samsung-review', type: 'url', isSamsung: false },
            { name: 'techradar.com/best-tvs', type: 'url', isSamsung: false },
            { name: 'tomsguide.com/gaming', type: 'url', isSamsung: false }
        ],
        links: [
            // Topics to Prompts
            { source: 0, target: 5, value: 120 },
            { source: 0, target: 6, value: 85 },
            { source: 1, target: 7, value: 95 },
            { source: 1, target: 8, value: 70 },
            { source: 2, target: 9, value: 110 },
            { source: 2, target: 11, value: 90 },
            { source: 3, target: 5, value: 80 },
            { source: 3, target: 8, value: 65 },
            { source: 4, target: 10, value: 100 },
            { source: 4, target: 9, value: 75 },
            // Prompts to URLs
            { source: 5, target: 12, value: 100, isSamsung: true },
            { source: 5, target: 14, value: 60 },
            { source: 6, target: 12, value: 50, isSamsung: true },
            { source: 6, target: 13, value: 35, isSamsung: true },
            { source: 7, target: 13, value: 45, isSamsung: true },
            { source: 7, target: 15, value: 50 },
            { source: 8, target: 14, value: 70 },
            { source: 8, target: 16, value: 40 },
            { source: 9, target: 12, value: 65, isSamsung: true },
            { source: 9, target: 17, value: 55 },
            { source: 10, target: 16, value: 60 },
            { source: 10, target: 14, value: 40 },
            { source: 11, target: 13, value: 50, isSamsung: true },
            { source: 11, target: 17, value: 40 }
        ]
    };

    function renderSankey(data) {
        const container = d3.select('#citation-sankey');
        container.selectAll('*').remove();

        const innerWidth = config.width - config.margin.left - config.margin.right;
        const innerHeight = config.height - config.margin.top - config.margin.bottom;

        const svg = container.append('svg')
            .attr('width', config.width)
            .attr('height', config.height);

        const g = svg.append('g')
            .attr('transform', `translate(${config.margin.left},${config.margin.top})`);

        // Create Sankey generator
        const sankey = d3.sankey()
            .nodeWidth(config.nodeWidth)
            .nodePadding(config.nodePadding)
            .extent([[0, 0], [innerWidth, innerHeight]]);

        // Generate Sankey layout
        const { nodes, links } = sankey({
            nodes: data.nodes.map(d => ({ ...d })),
            links: data.links.map(d => ({ ...d }))
        });

        // Draw links
        const link = g.append('g')
            .attr('fill', 'none')
            .selectAll('.sankey-link')
            .data(links)
            .join('path')
            .attr('class', d => {
                if (d.isSamsung) return 'sankey-link samsung';
                if (d.target.isSamsung === false) return 'sankey-link earned';
                return 'sankey-link other';
            })
            .attr('d', d3.sankeyLinkHorizontal())
            .attr('stroke-width', d => Math.max(1, d.width))
            .on('mouseenter', function(event, d) {
                d3.select(this).attr('stroke-opacity', 0.7);

                tooltip
                    .html(`
                        <div class="tooltip-flow">
                            <strong>${d.source.name}</strong> → <strong>${d.target.name}</strong>
                        </div>
                        <div class="tooltip-value">${d.value.toLocaleString()} citations</div>
                    `)
                    .classed('visible', true)
                    .style('left', (event.pageX + 10) + 'px')
                    .style('top', (event.pageY - 10) + 'px');
            })
            .on('mousemove', function(event) {
                tooltip
                    .style('left', (event.pageX + 10) + 'px')
                    .style('top', (event.pageY - 10) + 'px');
            })
            .on('mouseleave', function() {
                d3.select(this).attr('stroke-opacity', 0.4);
                tooltip.classed('visible', false);
            });

        // Draw nodes
        const node = g.append('g')
            .selectAll('.sankey-node')
            .data(nodes)
            .join('g')
            .attr('class', d => {
                let classes = `sankey-node ${d.type}`;
                if (d.type === 'url') {
                    classes += d.isSamsung ? ' samsung' : ' earned';
                }
                return classes;
            })
            .attr('transform', d => `translate(${d.x0},${d.y0})`);

        // Node rectangles
        node.append('rect')
            .attr('width', d => d.x1 - d.x0)
            .attr('height', d => d.y1 - d.y0)
            .attr('rx', 3)
            .on('mouseenter', function(event, d) {
                // Highlight connected links
                link.attr('stroke-opacity', l =>
                    l.source === d || l.target === d ? 0.7 : 0.1
                );

                const typeLabel = {
                    topic: 'Topic',
                    prompt: 'Prompt',
                    url: d.isSamsung ? 'Samsung URL' : 'External URL'
                }[d.type] || 'Node';

                const totalFlow = d.value || 0;

                tooltip
                    .html(`
                        <div class="tooltip-type">${typeLabel}</div>
                        <div class="tooltip-title">${d.name}</div>
                        <div class="tooltip-value">${totalFlow.toLocaleString()} total flow</div>
                    `)
                    .classed('visible', true)
                    .style('left', (event.pageX + 10) + 'px')
                    .style('top', (event.pageY - 10) + 'px');
            })
            .on('mousemove', function(event) {
                tooltip
                    .style('left', (event.pageX + 10) + 'px')
                    .style('top', (event.pageY - 10) + 'px');
            })
            .on('mouseleave', function() {
                link.attr('stroke-opacity', 0.4);
                tooltip.classed('visible', false);
            });

        // Node labels
        node.append('text')
            .attr('x', d => d.x0 < innerWidth / 2 ? (d.x1 - d.x0) + 6 : -6)
            .attr('y', d => (d.y1 - d.y0) / 2)
            .attr('dy', '0.35em')
            .attr('text-anchor', d => d.x0 < innerWidth / 2 ? 'start' : 'end')
            .text(d => {
                const name = d.name;
                return name.length > 30 ? name.substring(0, 28) + '...' : name;
            })
            .append('title')
            .text(d => d.name);
    }

    // Load data from Supabase
    async function loadSankeyData() {
        try {
            if (typeof SupabaseData === 'undefined') {
                console.warn('SupabaseData not available, using sample data');
                renderSankey(sampleData);
                return;
            }

            // Fetch both prompts and cited pages data
            const [promptData, citedData] = await Promise.all([
                SupabaseData.fetchUrlPrompts({ limit: 50 }),
                SupabaseData.fetchCitedPages({ limit: 50 })
            ]);

            if (promptData.length > 0 && citedData.length > 0) {
                const sankeyData = SupabaseData.transform.sankey(promptData, citedData);

                if (sankeyData.nodes.length > 0 && sankeyData.links.length > 0) {
                    renderSankey(sankeyData);
                } else {
                    renderSankey(sampleData);
                }
            } else {
                renderSankey(sampleData);
            }
        } catch (error) {
            console.error('Error loading Sankey data:', error);
            renderSankey(sampleData);
        }
    }

    // Listen for filter changes
    document.addEventListener('filtersChanged', loadSankeyData);

    // Initial render
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', loadSankeyData);
    } else {
        loadSankeyData();
    }
})();
</script>
